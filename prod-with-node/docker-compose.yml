version: '2.1'

services:
  php:
      build:
        context: ../docker_files
        dockerfile: php
      restart: unless-stopped
      environment:
        PHP_XDEBUG_ENABLED: 0 # Set 1 to enable.
      links:
        - db
      volumes:
        - ../app/back:/var/www/back
        - ../app/front:/var/www/front
        - ./php.ini:/usr/local/etc/php/conf.d/common.ini
  phpmyadmin:
      image: phpmyadmin/phpmyadmin
      container_name: phpmyadmin
      environment:
       - PMA_ARBITRARY=1
       - UPLOAD_LIMIT=99999999999999
      restart: always
      ports:
       - "8090:80"
      volumes:
       - ../sessions
  web:
      image: nginx:1.11-alpine
      restart: unless-stopped
      links:
        - php
      ports:
        - "8080:8080"
      volumes:
        - ./nginx.conf:/etc/nginx/conf.d/default.conf
        - /etc/ssl/ca_bundle.crt:/etc/ssl/ca_bundle.crt
        - /etc/ssl/certificate.crt:/etc/ssl/certificate.crt
        - /etc/ssl/private.key:/etc/ssl/private.key
      volumes_from:
        - php
  node:
      image: "node:latest"
      user: "www-data"
      working_dir: /var/www/front
      restart: unless-stopped
      environment:
        - NODE_ENV=production
      volumes:
        - ../app/front/public:/var/www/front
        - /etc/ssl/ca_bundle.crt:/etc/ssl/ca_bundle.crt
        - /etc/ssl/certificate.crt:/etc/ssl/certificate.crt
        - /etc/ssl/private.key:/etc/ssl/private.key
      ports:
        - "443:3001"
        - "80:3000"
      command: "node /var/www/front/__sapper__/build"
      links:
        - web
  db:
        image: mysql:5.7.23
        restart: unless-stopped
        env_file:
          - ../app/back/.env.local
        environment:
         - TZ=Europe/Moscow
        command: --innodb_use_native_aio=0
        volumes:
          - ../db:/var/lib/mysql
